# Environment Configuration

## Quick Start

### Setup Environment

```bash
# Create .env from template (one command for all scenarios)
make env
# or
cp .env.example .env
```

### Local Development (VSCode Debug)

1. Setup environment:
   ```bash
   make env
   ```

2. Start dependencies:
   ```bash
   make infra-up
   ```

3. Debug in VSCode (F5):
   - Select "Debug API", "Debug Consumer", or "Debug Worker"
   - Breakpoints and hot reload work automatically

### Docker Compose (Full Stack)

```bash
make docker-start
# or
make app-up
```

Access:
- **API**: http://localhost:8080
- **Grafana**: http://localhost:3000 (admin / admin@dev)
- **RabbitMQ**: http://localhost:15672 (guest / rabbitmq@dev)
- **CockroachDB UI**: http://localhost:8081

## File Structure

```
.env.example          # Template (commit this)
.env                  # Your values (DO NOT commit)
```

**That's it!** No duplicate files, single source of truth.

## How It Works

### Same .env for Local and Docker

The `.env` file is used for both local development and Docker:

**Local Development:**
- Uses `.env` directly
- Connects to `localhost:26257`, `localhost:5672`, etc.

**Docker Compose:**
- Uses `.env` as base
- **Automatically overrides** hosts via `environment:` in `docker-compose.yml`
- Connects to `cockroachdb:26257`, `rabbitmq:5672`, etc.

### What Gets Overridden in Docker

Only connection hosts are overridden. Everything else (credentials, settings) stays the same:

| Variable | .env (Local) | Docker Override |
|----------|--------------|-----------------|
| `DB_HOST` | `localhost` | `cockroachdb` |
| `RABBITMQ_URL` | `amqp://...@localhost:5672` | `amqp://...@rabbitmq:5672` |
| `OTEL_EXPORTER_OTLP_ENDPOINT` | `localhost:4317` | `otel-lgtm:4317` |
| **All other vars** | Used as-is | Used as-is |

## Security Notes

- ‚úÖ `.env.example` is committed (safe defaults)
- ‚ùå `.env` is gitignored (never commit)
- üîê Production: Use secrets manager (AWS Secrets Manager, Vault, etc)
- üîë Generate secrets: `openssl rand -hex 64`

## Configuration Variables

See `.env.example` for all available variables. Key sections:

- **Environment**: `ENVIRONMENT`, `HTTP_PORT`, service names
- **Database**: `DB_*` (host, port, user, password, pool settings)
- **Auth**: `AUTH_SECRET_KEY`, `AUTH_TOKEN_DURATION`
- **RabbitMQ**: `RABBITMQ_URL`, exchange, queue
- **Consumer**: `CONSUMER_*` (broker type, workers, prefetch)
- **Worker**: `WORKER_*` (timeout, concurrent jobs)
- **Outbox**: `OUTBOX_*` (polling, batch size, retries)
- **Observability**: `OTEL_*`, `LOG_LEVEL`, `LOG_FORMAT`

## Troubleshooting

**Q: My changes in .env aren't reflected in Docker**

A: Docker caches environment variables. Restart services:
```bash
make app-restart
# or
make app-down && make app-up
```

**Q: Can I have different credentials for Docker?**

A: Not recommended. Keep credentials the same for dev consistency. For different envs, use different machines/configs.

**Q: Where did deployment/.env.docker go?**

A: Removed! We now use a single `.env` file. Docker overrides only what's needed via `docker-compose.yml`.

## Migration from Old Structure

If you had the old structure with multiple .env files:

```bash
# Old structure (deprecated)
.env.example
cmd/.env.example
deployment/.env.docker

# New structure (current)
.env.example          # Single template
.env                  # Single config
```

Migration steps:
```bash
# 1. Backup old files (if needed)
cp cmd/.env cmd/.env.backup

# 2. Remove duplicates
rm -f cmd/.env.example cmd/.env
rm -f deployment/.env.docker deployment/.env

# 3. Create new .env from template
make env

# 4. Done! Use same commands as before
make dev-setup
```
